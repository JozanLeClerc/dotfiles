#!/usr/local/bin/dash

upgrdports() {
	sudo pkg update
	sudo portsnap fetch update
	printf "%s\nPackages to be updated:\n" "-------------------"
	pkg version -l "<"
	upnbr=$(pkg version -l "<" | wc -l | awk '{print $1}')
	if [ "$2" != "-y" ]; then
		printf "Upgrade these ports? [y/N]\n"
		printf "~> "
		read -r answer
		[ "$answer" != "y" ] || [ "$answer" != "Y" ] && exit 0
	fi
	notify-send "Initiating upgrade" "Ports upgrade has started\nTotal: $upnbr to be updated"
	if [ "$upnbr" -eq 1 ]; then
		espeak "Initiating $upnbr port upgrade" &
	else
		espeak "Initiating $upnbr ports upgrade" &
	fi
	if sudo portupgrade -a; then
		failednbr=$(pkg version -l "<" | wc -l | awk '{print $1}')
		diffnbr=$((upnbr - failednbr))
		notify-send "Upgrade complete!" "Ports upgrade installed successfully\nTotal: $diffnbr installed - $failednbr failed"
		espeak "Success: $upnbr ports upgrade installed successfully" &
	else
		failednbr=$(pkg version -l "<" | wc -l | awk '{print $1}')
		diffnbr=$((upnbr - failednbr))
		notify-send -u critical "Upgrade failed!" "Some ports failed to compile\nTotal: $diffnbr installed - $failednbr failed"
		espeak "Failure: not all ports were upgraded - $diffnbr succeeded - $failednbr failed" &
	fi
	exit 0
}

configport() {
	if sudo make config-recursive \
			&& sudo make config-recursive \
			&& sudo make config-recursive; then
		notify-send "Configuration success!" "Ports config - $1 - configured successfully"
		espeak "Success: $prt_n configured successfully. Initiating compilation." &
	else
		notify-send -u critical "Configuration failure!" "Ports config - $1 - failed to configure"
		espeak "Failure: failed to configure $prt_n" &
	fi
}

installport() {
	if sudo make install clean; then
		notify-send "Compilation success!" "Ports - $1 - compiled successfully"
		espeak "Success: $prt_n compiled successfully" &
	else
		notify-send -u critical "Compilation failure!" "Ports - $1 - failed to compile"
		espeak "Failure: failed to compile $prt_n" &
	fi
}

[ $# -eq 0 ] && printf "Failed! No port or argument specified.\n" && exit 1
[ "$1" = "upgrade" ] && upgrdports "$@"
[ ! -d "/usr/ports/$1" ] && printf "Failed! Port /usr/ports/%s doesn't exist\n" "$1" && exit 2

prt_n=$(echo "$1" | awk -F '/' '{print $2}')

printf "Port %s found\n" "$1"
cd "/usr/ports/$1" || exit 3

configport "$@" && installport "$@"

exit 0
